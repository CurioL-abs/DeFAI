resolver 127.0.0.11 valid=10s ipv6=off;

server {
    listen 80;
    server_name localhost;

    # Common proxy headers
    proxy_set_header X-Request-ID $request_id;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Host $host;

    # Backend API — pass full path through
    location /api/v1/ {
        set $backend http://backend:8000;
        proxy_pass $backend;
    }

    # Agent Engine API — rewrite /api/agents/* to /agents/*
    location /api/agents/ {
        set $agent http://agent-engine:8002;
        rewrite ^/api/agents/(.*)$ /agents/$1 break;
        proxy_pass $agent;
    }

    location /api/strategies/ {
        set $agent http://agent-engine:8002;
        rewrite ^/api/strategies/(.*)$ /strategies/$1 break;
        proxy_pass $agent;
    }

    location /api/monitoring/ {
        set $agent http://agent-engine:8002;
        rewrite ^/api/monitoring/(.*)$ /monitoring/$1 break;
        proxy_pass $agent;
    }

    # AI Service health
    location /api/ai/health {
        set $ai http://ai:8001;
        rewrite ^/api/ai/(.*)$ /$1 break;
        proxy_pass $ai;
    }

    # Health check endpoints
    location /health/backend {
        set $backend http://backend:8000;
        rewrite ^/health/backend$ /health break;
        proxy_pass $backend;
    }

    location /health/agent-engine {
        set $agent http://agent-engine:8002;
        rewrite ^/health/agent-engine$ /health break;
        proxy_pass $agent;
    }

    location /health/ai {
        set $ai http://ai:8001;
        rewrite ^/health/ai$ /health break;
        proxy_pass $ai;
    }

    # WebSocket support
    location /ws {
        set $agent http://agent-engine:8002;
        proxy_pass $agent;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Frontend (catch-all)
    location / {
        set $frontend http://frontend:3000;
        proxy_pass $frontend;
    }
}
